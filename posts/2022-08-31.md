---
title: '[next.js] SSR でデバイスの種類を取得したい'
date: '2022/8/30'
excerpt: ''
cover_image: ''
category: 'next.js'
---

## SSR では window.Navigator.userAgent が使えない
クライアント側でデバイスの種類を取得死体と場合は window.Navigator.userAgent を使用すればいいけれども、SSR 時は当然ながら window オブジェクトが存在しないので window.Navigator.userAgent を仕様することはできない。

## getServerSideProps の context から request.headers 内の user-agent を取得する

```ts
 export async function getServerSideProps(context: any) {
  try {
    // この userAgent を使えばどうとでも判断できる
    const userAgent = context.req.headers['user-agent'];
    const response = await axios.get('https://example.com/api/hoge');
    return ({ props: { games: response.data }});
  } catch (e) {
    console.error('[error] / SSR error', e)
    return {
      notFound: true,
    };
  }
}
```

## 実装編

使用するライブラリ
- ismobilejs: ^1.1.1

```sh
$ npm i ismobilejs
```

- UserAgentClass を実装する

```ts
import isMobile from 'ismobilejs';

interface IUserAgentController {
  serverSideInitialize: (userAgent: any) => void,
  clientSideInitialize: () => void,

  isMobile: () => boolean,
  isTablet: () => boolean,
  isDesktop: () => boolean,
}

export class UserAgentClass implements IUserAgentController {

  private _isMobile: boolean = false;
  private _isTablet: boolean = false;
  private _isDesktop: boolean = false;

  constructor() {}

  serverSideInitialize(userAgent: any) {
    if (this.isInitialized()) {
      return;
    }

    const mobile = isMobile(userAgent).any;
    const tablet = isMobile(userAgent).tablet;

    this._isMobile = mobile && !tablet;
    this._isTablet = tablet;
    this._isDesktop = !mobile && !tablet;
  }

  clientSideInitialize() {
    if (this.isInitialized()) {
      return;
    }

    const mobile = isMobile().any;
    const tablet = isMobile().tablet;

    this._isMobile = mobile && !tablet;
    this._isTablet = tablet;
    this._isDesktop = !mobile && !tablet;
  };

  isMobile() {
    if (!this.isInitialized()) {
      this.clientSideInitialize();
    }
    return this._isMobile;
  };

  isTablet() {
    if (!this.isInitialized()) {
      this.clientSideInitialize();
    }
    return this._isTablet;
  }

  isDesktop() {
    if (!this.isInitialized()) {
      this.clientSideInitialize();
    }
    return this._isDesktop;
  };

  private isInitialized() {
    return [this._isMobile, this._isTablet, this._isDesktop].some((bool) => bool);
  }

}

export const UserAgent = new UserAgentClass();
```

- SSR するコンポネント側

```ts
import type { NextPage } from 'next';

const Home: NextPage<HomeProps> = (props) => {
  const { hoge } = props;

  console.log('isMobile', UserAgent.isMobile());
  console.log('isTablet', UserAgent.isTablet());
  console.log('isDesktop', UserAgent.isDesktop());

  return <Hoge hoge={hoge} />;
}

export async function getServerSideProps(context: any) {
  try {
    // この userAgent を使えばどうとでも判断できる
    const userAgent = context.req.headers['user-agent'];
    // 初期化
    UserAgent.serverSideInitialize(userAgent);
    const response = await axios.get('https://example.com/api/hoge');
    return ({ props: { hoge: response.data }});
  } catch (e) {
    console.error('[error] / SSR error', e)
    return {
      notFound: true,
    };
  }
}
```

## おわり
いったんこれで大丈夫そうかな。